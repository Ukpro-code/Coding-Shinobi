{% extends "base.html" %}

{% block title %}Goals - Productivity Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-bullseye me-2"></i>Goals</h2>
            <a href="{{ url_for('add_goal') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Goal
            </a>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-target me-2"></i>Your Goals
                </h5>
            </div>
            <div class="card-body">
                {% if goals %}
                    <!-- Enhanced Goal Countdown Display -->
                    <div id="goal-countdowns" class="goal-countdown-container">
                        <div class="goal-countdown-grid">
                            {% for goal in goals %}
                            <div class="goal-card goal-normal" data-goal-id="{{ goal.id }}">
                                <div class="goal-header">
                                    <h6 class="goal-title">{{ goal.title }}</h6>
                                    <span class="goal-type-badge">{{ goal.goal_type.title() }}</span>
                                </div>
                                
                                <div class="goal-progress-section">
                                    <div class="progress-ring-container">
                                        <svg class="progress-ring" width="80" height="80">
                                            <circle class="progress-ring-circle-bg" cx="40" cy="40" r="35"></circle>
                                            <circle class="progress-ring-circle" cx="40" cy="40" r="35" 
                                                    stroke-dasharray="{{ 2 * 3.14159 * 35 }}"
                                                    stroke-dashoffset="{{ 2 * 3.14159 * 35 * (1 - goal.progress / 100) }}">
                                            </circle>
                                        </svg>
                                        <div class="progress-text">
                                            <span class="progress-percentage">{{ goal.progress|round|int }}%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="countdown-display">
                                        <div class="countdown-unit">
                                            <span class="countdown-number" data-unit="days">{{ goal.days_remaining }}</span>
                                            <span class="countdown-label">Days</span>
                                        </div>
                                        <div class="countdown-unit">
                                            <span class="countdown-number" data-unit="hours">0</span>
                                            <span class="countdown-label">Hours</span>
                                        </div>
                                        <div class="countdown-unit">
                                            <span class="countdown-number" data-unit="minutes">0</span>
                                            <span class="countdown-label">Min</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="goal-actions">
                                    <button class="btn btn-sm btn-primary" onclick="updateGoalProgress({{ goal.id }})">
                                        <i class="fas fa-plus"></i> Update Progress
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="viewGoalDetails({{ goal.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </div>
                                
                                <div class="goal-description">
                                    {% if goal.description %}
                                        <p>{{ goal.description }}</p>
                                    {% else %}
                                        <p>No description available</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Hidden data for JavaScript -->
                                <script type="application/json" class="goal-data">
                                    {
                                        "id": {{ goal.id }},
                                        "title": "{{ goal.title }}",
                                        "description": "{{ goal.description or '' }}",
                                        "target_date": "{{ goal.target_date.isoformat() }}",
                                        "progress": {{ goal.progress }},
                                        "goal_type": "{{ goal.goal_type }}",
                                        "status": "{{ goal.status }}"
                                    }
                                </script>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                        <h4>No goals set yet</h4>
                        <p class="text-muted">Set your first goal and start achieving your dreams!</p>
                        <a href="{{ url_for('add_goal') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Set Your First Goal
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Goal Stats -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">{{ goals|length }}</h3>
                <p class="text-muted mb-0">Total Goals</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ goals|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                <p class="text-muted mb-0">Completed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-info">{{ goals|selectattr('status', 'equalto', 'active')|list|length }}</h3>
                <p class="text-muted mb-0">Active</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-warning">{{ (goals|sum(attribute='progress') / goals|length)|round(1) if goals else 0 }}%</h3>
                <p class="text-muted mb-0">Avg Progress</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/goal-countdown.js') }}"></script>
<script>
    // Initialize goal countdown with data from server
    document.addEventListener('DOMContentLoaded', function() {
        // Load goals from the hidden JSON data
        const goalDataElements = document.querySelectorAll('.goal-data');
        const goals = Array.from(goalDataElements).map(el => JSON.parse(el.textContent));
        
        // Store goals in localStorage for the countdown system
        localStorage.setItem('goals', JSON.stringify(goals));
        
        // Initialize goal countdown system
        window.goalCountdown = new GoalCountdown();
    });
    
    // Handle goal progress updates
    function updateGoalProgress(goalId) {
        const newProgress = prompt('Enter new progress percentage (0-100):');
        if (newProgress !== null) {
            const progress = parseInt(newProgress);
            if (!isNaN(progress) && progress >= 0 && progress <= 100) {
                // Update via server
                fetch(`/api/goals/${goalId}/progress`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ progress: progress })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update local countdown system
                        window.goalCountdown.updateGoalProgress(goalId, progress);
                        
                        // Show success message
                        const toast = document.createElement('div');
                        toast.className = 'alert alert-success';
                        toast.textContent = 'Goal progress updated successfully!';
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    } else {
                        alert('Failed to update goal progress');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update goal progress');
                });
            } else {
                alert('Please enter a valid percentage between 0 and 100');
            }
        }
    }
    
    function viewGoalDetails(goalId) {
        // This would open a modal or redirect to goal details
        window.location.href = `/goals/${goalId}`;
    }
</script>
{% endblock %}
